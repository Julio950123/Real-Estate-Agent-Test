<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨­å®šè¨‚é–±æ¢ä»¶</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f9f9f9;
        }
        .form-container {
            max-width: 480px;
            margin: 40px auto;
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h2 {
            text-align: center;
            margin-bottom: 25px;
            font-weight: bold;
            color: #333;
        }
        button {
            transition: all 0.2s ease-in-out;
        }
        button:hover {
            transform: scale(1.03);
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h2>è¨­å®šæ‚¨çš„è¨‚é–±æ¢ä»¶</h2>
        <form id="subscribeForm">
            
            <!-- é ç®— -->
            <div class="mb-3">
                <label class="form-label">é ç®—</label>
                <select name="budget" class="form-select" required>
                    <option value="">è«‹é¸æ“‡é ç®—</option>
                    <option value="0-1000">1000è¬ä»¥ä¸‹</option>
                    <option value="1001-1500è¬">1000-1500è¬</option>
                    <option value="1501-2000è¬">1500-2000è¬</option>
                    <option value="2001-2500è¬">2000-2500è¬</option>
                    <option value="2501-3000è¬">2500-3000è¬</option>
                    <option value="3000è¬ä»¥ä¸Š">3000è¬ä»¥ä¸Š</option>
                </select>
            </div>

            <!-- é¡å‹ -->
            <div class="mb-3">
                <label class="form-label">å‹æ…‹</label>
                <select name="genre" id="genre" class="form-select" required>
                    <option value="">è«‹é¸æ“‡å‹æ…‹</option>
                    <option value="é›»æ¢¯å¤§æ¨“">é›»æ¢¯å¤§æ¨“</option>
                    <option value="å…¬å¯“">å…¬å¯“</option>
                    <option value="é€å¤©å">é€å¤©å</option>
                    <option value="åº—é¢">åº—é¢</option>
                    <option value="åœŸåœ°">åœŸåœ°</option>
                    <option value="è¾¦å…¬">è¾¦å…¬</option>
                </select>
            </div>

            <!-- æ ¼å±€ -->
            <div class="mb-3" id="roomField">
                <label class="form-label">æ ¼å±€</label>
                <select name="room" class="form-select">
                    <option value="">è«‹é¸æ“‡æ ¼å±€</option>
                    <option value="1æˆ¿">1æˆ¿</option>
                    <option value="2æˆ¿">2æˆ¿</option>
                    <option value="3æˆ¿">3æˆ¿</option>    
                    <option value="4æˆ¿">4æˆ¿</option>
                    <option value="5æˆ¿">5æˆ¿</option>
                </select>
            </div>

            <!-- éš±è— user_id -->
            <input type="hidden" name="user_id" id="user_id">

            <!-- é€å‡ºæŒ‰éˆ• -->
            <button type="submit" class="btn btn-success w-100">é€å‡º</button>

            <style>
            .btn-success {
                background-color: #EB941E !important;
                border-color: #EB941E !important;
            }
            .btn-success:hover {
                background-color: #d47f15 !important;
                border-color: #d47f15 !important;
            }
            </style>
        </form>
    </div>

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const LIFF_ID = "2007821360-8WJy7BmM"; // âš ï¸ æ›æˆä½ çš„ LIFF ID

        async function initLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                document.getElementById("user_id").value = profile.userId;
                console.log("âœ… å–å¾— user_id:", profile.userId);

            } catch (error) {
                console.error("âŒ LIFF åˆå§‹åŒ–å¤±æ•—:", error);
                alert("âš ï¸ LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°é–‹å•Ÿé€£çµ");
            }
        }

        // ğŸ‘‡ æ–°å¢ï¼šæ ¹æ“šå‹æ…‹é¡¯ç¤ºæˆ–éš±è—ã€Œæ ¼å±€ã€
        document.getElementById("genre").addEventListener("change", function() {
            const genre = this.value;
            const roomField = document.getElementById("roomField");
            const hiddenTypes = ["åº—é¢", "åœŸåœ°", "è¾¦å…¬"];

            if (hiddenTypes.includes(genre)) {
                roomField.style.display = "none";
            } else {
                roomField.style.display = "block";
            }
        });

        // æ”¹ç”¨ AJAX æäº¤
        document.getElementById("subscribeForm").addEventListener("submit", async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const payload = Object.fromEntries(formData.entries());

            try {
                let res = await fetch("/submit_form", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    if (liff.isInClient()) {
                        liff.closeWindow(); // âœ… åœ¨ LINE å…§ç›´æ¥é—œé–‰
                    } else {
                        window.close();
                        location.href = "/thank-you";
                    }
                } else {
                    alert("é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                }
            } catch (err) {
                console.error("âŒ è¡¨å–®é€å‡ºéŒ¯èª¤:", err);
                alert("é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            }
        });

        initLiff();
    </script>
</body>
</html>
